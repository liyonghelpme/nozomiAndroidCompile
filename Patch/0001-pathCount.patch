From 9bcf37e810f06b5e075e0ce07ab5c6dd4fbb6b1c Mon Sep 17 00:00:00 2001
From: liyonghelpme <liyonghelpme@gmail.com>
Date: Tue, 7 May 2013 09:16:26 +0800
Subject: [PATCH 1/2] =?UTF-8?q?=E5=8F=AA=E8=AE=BE=E5=AE=9A=E6=9C=80=E5=90?=
 =?UTF-8?q?=8E=E4=B8=80=E4=B8=AA=E8=B7=AF=E5=BE=84=E7=82=B9=E7=9A=84pathCo?=
 =?UTF-8?q?unt=20=E6=9D=A5=E8=AE=A1=E6=95=B0=20=E4=B8=8B=E6=AC=A1=E5=AF=BB?=
 =?UTF-8?q?=E8=B7=AF=E6=88=96=E8=80=85=E6=AD=BB=E4=BA=A1=E7=9A=84=E6=97=B6?=
 =?UTF-8?q?=E5=80=99=20=E6=B8=85=E7=90=86=E4=B8=8A=E6=AC=A1=E7=9A=84=E8=B7?=
 =?UTF-8?q?=AF=E5=BE=84=E8=AE=A1=E6=95=B0=E4=BF=A1=E6=81=AF?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 README.mdown                       |  6 ++++++
 nozomi/Resources/Mould/Person.lua  | 44 ++++++++++++++++++++++++++++++++------
 nozomi/Resources/Mould/Soldier.lua | 13 ++++++-----
 nozomi/Resources/Util/World.lua    | 11 ++++++++--
 4 files changed, 60 insertions(+), 14 deletions(-)

diff --git a/README.mdown b/README.mdown
index a4a16b9..ad3cebc 100644
--- a/README.mdown
+++ b/README.mdown
@@ -59,3 +59,9 @@ AppDelegate
 »Áπ˚÷–Õæ«–ªª“∆∂Øƒø±Í ‘Ú«Â¿Ì◊‘…Ìµƒpath
 
 »Áπ˚ ø±¯À¿Õˆ“≤«Â¿Ì◊‘…Ìµƒpath
+
+¥Ú≤π∂°
+----
+patch -p1 < xxx.patch
+
+»Áπ˚¥Ê‘⁄≥ÂÕªª·”–≥ÂÕªfile …˙≥…
diff --git a/nozomi/Resources/Mould/Person.lua b/nozomi/Resources/Mould/Person.lua
index 8b636b7..fb0bc49 100644
--- a/nozomi/Resources/Mould/Person.lua
+++ b/nozomi/Resources/Mould/Person.lua
@@ -1,4 +1,5 @@
 require "Util.Class"
+local simpleJson = require "Util.SimpleJson"
 
 Person = class()
 
@@ -165,9 +166,11 @@ end
 --ºÏ≤‚∑«œ‡¡⁄µ„÷Æº‰ «∑Ò¥Ê‘⁄’œ∞≠ŒÔ
 --Ω´◊¯±Í¥”affineÕ¯∏Ò◊¯±Í◊™ªØ≥…µ—ø®∂˚◊¯±Í
 function Person:getTruePath(path, world, mapGrid, fx, fy, tx, ty)
+    local oldPath = path
 	local i = 1
     local j = 3
-	local tempPath = {path[1]}
+    local info = {path[1][1], path[1][2], 1}
+	local tempPath = {info}
     while j <= #path do
         local ray = Ray.new(path[i], path[j], world)
         local ret = ray:checkCollision()
@@ -181,7 +184,13 @@ function Person:getTruePath(path, world, mapGrid, fx, fy, tx, ty)
             table.insert(tempPath, info)
         end
     end
-    table.insert(tempPath, path[#path])
+
+    local info = {path[#path][1], path[#path][2], #path}
+    table.insert(tempPath, info)
+
+    print("getTruePath")
+    print(simpleJson:encode(tempPath))
+
     path = tempPath
     --πÿ±’µ˜ ‘π¶ƒ‹≤ªµ˜”√∏√∫Ø ˝
     if world.debug then
@@ -196,14 +205,16 @@ function Person:getTruePath(path, world, mapGrid, fx, fy, tx, ty)
 	if #path==0 then
 		return {{tx, ty, 1}}
 	end
-	local curGrid = path[1]
+	--local curGrid = path[1]
 	for i=2, #path-1 do
 		local grid = path[i]
 		local position = mapGrid:convertToPosition(grid[1]/2, grid[2]/2)
 		table.insert(truePath, {position[1], position[2]+mapGrid.sizeY/4, grid[3]})
 	end
     --last path position
-	table.insert(truePath, {tx, ty, #path})
+	table.insert(truePath, {tx, ty, #oldPath})
+    print("world truePath is")
+    print(simpleJson:encode(truePath))
 	return truePath
 end
 		
@@ -248,6 +259,8 @@ function Person:setFromToGrid(f, t)
 end
 
 function Person:clearPathCount(from, to)
+    --÷–º‰≤ª«Â¿Ì¬∑æ∂–≈œ¢ ÷±µΩ◊ﬂµΩƒøµƒµÿ≤≈«Â¿Ì
+    --[[
     local w = self.scene.mapWorld
     if self.gridPath ~= nil then
         local start = from[3]
@@ -259,24 +272,39 @@ function Person:clearPathCount(from, to)
             end
         end
     end
+    ]]--
 end
 
 function Person:setPathCount() 
     print("setPathCount")
     local w = self.scene.mapWorld
+    --÷ª…Ë∂®◊Ó∫Û“ª∏ˆŒª÷√µƒpath count
+    local l = #self.gridPath
+    w:addPathCount(self.gridPath[l][1], self.gridPath[l][2])
+
+    --[[
     for k, v in ipairs(self.gridPath) do
         w:addPathCount(v[1], v[2]) 
     end
+    ]]--
+
 end
+--«Â¿ÌÀ˘”–µƒ¬∑æ∂–≈œ¢
 function Person:clearAllPath()
     print("clearAllPath")
     local w = self.scene.mapWorld
     if self.gridPath ~= nil then
-        local start = self.curGrid[3] --¥”µ±«∞√ª”–«Â¿Ìµƒ¬∑æ∂ø™ º«Â¿Ì
+        local l = #self.gridPath
+        w:minusPathCount(self.gridPath[l][1], self.gridPath[l][2])
+        --[[
+        local start = 1 --¥”µ±«∞√ª”–«Â¿Ìµƒ¬∑æ∂ø™ º«Â¿Ì
         local finish = #self.gridPath
+
+        print("AllPath length " .. #self.gridPath .." "..start)
         for i = start, finish, 1 do
             w:minusPathCount(self.gridPath[i][1], self.gridPath[i][2])
         end
+        ]]--
         self:finishPath()
     end
 end
@@ -330,8 +358,10 @@ function Person:update(diff)
                 self:setFromToGrid(self.nextGrid, point)
 				self:moveDirect(point[1], point[2])
 			else --◊Ó∫Û“ª∏ˆ“∆∂ØÕ¯∏Ò
-                self:clearPathCount(self.curGrid, self.nextGrid)
-                self:finishPath()
+                --‘⁄œ¬¥Œ“∆∂Øø™ ºµƒ ±∫Ú«Â¿Ì¬∑æ∂–≈œ¢ ‘Úƒ‹±£÷§∑¿÷ππ•ª˜Ω®÷˛ŒÔµƒ¬∑æ∂≥ÂÕª
+                --self:clearPathCount(self.curGrid, self.nextGrid)
+                --self:finishPath()
+
 				self.state = PersonState.STATE_FREE
 				self.backStateInfo = self.stateInfo
 				self.backTime = self.stateTime
diff --git a/nozomi/Resources/Mould/Soldier.lua b/nozomi/Resources/Mould/Soldier.lua
index cf32790..9fa922c 100644
--- a/nozomi/Resources/Mould/Soldier.lua
+++ b/nozomi/Resources/Mould/Soldier.lua
@@ -261,12 +261,15 @@ function Soldier:searchAttack()
             self:clearAllPath()
             self.gridPath = path
             self.truePath = truePath
-            self.setFromToGrid(self.truePath[1], self.truePath[1])
+            --µ⁄“ª∏ˆ∂•µ„
+            self.setFromToGrid({0, 0, 1}, self.truePath[1])
             self:setPathCount()
 
-            --print("self Data")
-            --print(simpJson:encode(self.gridPath))
-            --print(simpJson:encode(self.truePath))
+            print("self path Data")
+            print(simpJson:encode(self.gridPath))
+            print(simpJson:encode(self.truePath))
+            w:showGrid()
+
         end	
         --print("test2")
             
@@ -279,7 +282,7 @@ function Soldier:searchAttack()
                     self.stateTime = 0
                 end
                 --…Ë∂®µ±«∞Ω◊∂ŒµƒÕ¯∏Òø™ º Ω· ¯±‡∫≈ 
-                self:setFromToGrid(firstPoint, firstPoint)
+                self:setFromToGrid({0, 0, 1}, firstPoint)
                 self:moveDirect(firstPoint[1], firstPoint[2], true)
             else
                 self:setAttack()
diff --git a/nozomi/Resources/Util/World.lua b/nozomi/Resources/Util/World.lua
index 6b0c61e..02e96fe 100644
--- a/nozomi/Resources/Util/World.lua
+++ b/nozomi/Resources/Util/World.lua
@@ -51,7 +51,7 @@ function World:ctor(cellNum, coff)
     self.scene = nil
 
     --ÊòØÂê¶ÊòæÁ§∫Ë∞ÉËØïÂùó
-    self.debug = false
+    self.debug = true
 end
 function World:setScene(s)
     self.scene = s
@@ -109,6 +109,11 @@ function World:showGrid()
                 local temp = CCSprite:create("block.png")
                 if self.cells[key]['pathCount'] ~= nil and self.cells[key]['pathCount'] > 0 then
                     temp:setColor(ccc3(255, 255, 0)) 
+                    local word = CCLabelTTF:create(""..self.cells[key]['pathCount'], "Arial", 30)
+                    word:setColor(ccc3(255, 0, 255))
+                    word:setPosition(23, 17.5)
+                    word:setAnchorPoint(ccp(0.5, 0.5))
+                    temp:addChild(word)
                 elseif self.cells[key]['isPath'] and not self.cells[key]['isReal'] then
                     temp:setColor(ccc3(0, 255, 0))
                 elseif self.cells[key]['isReal'] then
@@ -121,11 +126,13 @@ function World:showGrid()
                 temp:setScaleX(46/cs.width)
                 temp:setScaleY(34.5/cs.height)
                 self.calGrid:addChild(temp)
+                --[[
                 local word = CCLabelTTF:create(""..self.cells[key]['fScore'], "Arial", 20)
                 word:setColor(ccc3(255, 0, 0))
                 word:setPosition(23, 17.5)
                 word:setAnchorPoint(ccp(0.5, 0.5))
                 temp:addChild(word)
+                ]]--
                 --ÊàëÁöÑÂùêÊ†áx y ËΩ¥ Âíå Ê∏∏Êàè‰∏≠ÁöÑ x y ËΩ¥Áõ∏Âèç
                 local nx, ny = affineToNormal(y, x)
                 local px, py = normalToCartesian(nx, ny)
@@ -235,7 +242,7 @@ function World:setBuild(x, y, size, btype, obj)
 			end
 		end
 	end
-    self:showGrid()
+    --self:showGrid()
 end
 
 --Ê∏ÖÁêÜÂª∫Á≠ëÁâ©ÁöÑÁΩëÊ†º
-- 
1.8.1.msysgit.1

