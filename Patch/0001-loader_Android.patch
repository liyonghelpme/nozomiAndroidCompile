From f6b61e4c8403ce966ae3773d66d7db82c49b0ffc Mon Sep 17 00:00:00 2001
From: liyonghelpme <liyonghelpme@gmail.com>
Date: Wed, 1 May 2013 13:29:02 +0800
Subject: [PATCH 01/12] =?UTF-8?q?=E4=BF=AE=E6=AD=A3loader=5FAndroid=20=E5?=
 =?UTF-8?q?=8A=A0=E8=BD=BD=E8=84=9A=E6=9C=AC=E4=BB=B6=20=E6=9B=BF=E6=8D=A2?=
 =?UTF-8?q?=20=E8=B7=AF=E5=BE=84=E5=88=86=E5=89=B2=E7=AC=A6=E5=8F=B7=20.?=
 =?UTF-8?q?=20=E4=B8=BA=20/=20=E5=A2=9E=E5=8A=A0assets=20=E8=B7=AF=E5=BE?=
 =?UTF-8?q?=84?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 nozomi/Classes/AppDelegate.cpp                        | 11 ++++++++++-
 nozomi/Classes/cocos2dx_support/Cocos2dxLuaLoader.cpp | 11 +++++++++--
 2 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/nozomi/Classes/AppDelegate.cpp b/nozomi/Classes/AppDelegate.cpp
index cbdcef7..acaaf6c 100644
--- a/nozomi/Classes/AppDelegate.cpp
+++ b/nozomi/Classes/AppDelegate.cpp
@@ -1,3 +1,5 @@
+#define COCOS2D_DEBUG 1
+
 #include "cocos2d.h"
 #include "CCEGLView.h"
 #include "AppDelegate.h"
@@ -31,12 +33,19 @@ bool AppDelegate::applicationDidFinishLaunching()
     // set FPS. the default value is 1.0/60 if you don't call this
     pDirector->setAnimationInterval(1.0 / 60);
 
+    CCFileUtils *fileUtil = CCFileUtils::sharedFileUtils();
+    CCLog("CCFileUtils initial %x", fileUtil);
+    CCLog("Init App Delegate");
+    
+
     // register lua engine
     CCLuaEngine* pEngine = CCLuaEngine::defaultEngine();
     CCScriptEngineManager::sharedManager()->setScriptEngine(pEngine);
 
 #if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID)
-    CCString* pstrFileContent = CCString::createWithContentsOfFile("main.lua");
+    pEngine->addSearchPath("assets");
+    //需要实际路径 因为zip 打开的是 整个apk文件 其中lua文件在assets中
+    CCString* pstrFileContent = CCString::createWithContentsOfFile("assets/main.lua");
     if (pstrFileContent)
     {
         pEngine->executeString(pstrFileContent->getCString());
diff --git a/nozomi/Classes/cocos2dx_support/Cocos2dxLuaLoader.cpp b/nozomi/Classes/cocos2dx_support/Cocos2dxLuaLoader.cpp
index df1c519..46e8449 100644
--- a/nozomi/Classes/cocos2dx_support/Cocos2dxLuaLoader.cpp
+++ b/nozomi/Classes/cocos2dx_support/Cocos2dxLuaLoader.cpp
@@ -28,12 +28,19 @@ using namespace cocos2d;
 
 extern "C"
 {
+    //替换路径里面的 . 为 xxx/xxx.lua
     int loader_Android(lua_State *L)
     {
         std::string filename(luaL_checkstring(L, 1));
         filename.append(".lua");
+        std::string fullName = "assets/"+filename;
+        int position = fullName.find(".");
+        while(position != std::string::npos) {
+            fullName.replace(position, 1, "/");
+        }
+        CCLog("loader_Android file %s", fullName.c_str());
+        CCString* pFileContent = CCString::createWithContentsOfFile(fullName.c_str());
 
-        CCString* pFileContent = CCString::createWithContentsOfFile(filename.c_str());
 
         if (pFileContent)
         {
@@ -50,4 +57,4 @@ extern "C"
 
         return 1;
     }
-}
\ No newline at end of file
+}
-- 
1.8.1.msysgit.1

